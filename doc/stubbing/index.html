
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Modern PHP Mocking Framwork for PHP7 and PHP8.
">
      
      
      
        <link rel="canonical" href="https://phake.github.io/doc/stubbing/">
      
      
        <link rel="prev" href="../mocks/">
      
      
        <link rel="next" href="../method-verification/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.3">
    
    
      
        <title>Method Stubbing - Phake - PHP Mocking Framework</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.d7758b05.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-ZH298BGVL6"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-ZH298BGVL6",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-ZH298BGVL6",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#method-stubbing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Phake - PHP Mocking Framework" class="md-header__button md-logo" aria-label="Phake - PHP Mocking Framework" data-md-component="logo">
      
  <img src="../../assets/images/phake-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phake - PHP Mocking Framework
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Method Stubbing
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/phake/phake" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    phake/phake
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../getting-started/" class="md-tabs__link">
        
  
    
  
  Getting started

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  Documentation

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../cheat-sheet/" class="md-tabs__link">
        
  
    
  
  Cheat sheet

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Phake - PHP Mocking Framework" class="md-nav__button md-logo" aria-label="Phake - PHP Mocking Framework" data-md-component="logo">
      
  <img src="../../assets/images/phake-white.svg" alt="logo">

    </a>
    Phake - PHP Mocking Framework
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/phake/phake" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    phake/phake
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Documentation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mocks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Creating Mocks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Method Stubbing
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Method Stubbing
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-phakewhen-works" class="md-nav__link">
    <span class="md-ellipsis">
      How Phake::when() Works
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overwriting-existing-stubs" class="md-nav__link">
    <span class="md-ellipsis">
      Overwriting Existing Stubs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resetting-a-mocks-stubs" class="md-nav__link">
    <span class="md-ellipsis">
      Resetting A Mock's Stubs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stubbing-multiple-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Stubbing Multiple Calls
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stubbing-consecutive-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Stubbing Consecutive Calls
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stubbing-reference-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Stubbing Reference Parameters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#partial-mocks" class="md-nav__link">
    <span class="md-ellipsis">
      Partial Mocks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-default-stubs" class="md-nav__link">
    <span class="md-ellipsis">
      Setting Default Stubs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stubbing-magic-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Stubbing Magic Methods
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../method-verification/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Method Verification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mocking-statics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mocking Static Methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../answers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Answers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../method-parameter-matchers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Method Parameter Matchers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_9" >
        
          
          <label class="md-nav__link" for="__nav_3_9" id="__nav_3_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Cookbooks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            Cookbooks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cookbooks/annotations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Annotations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheat-sheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cheat sheet
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="method-stubbing">Method Stubbing<a class="headerlink" href="#method-stubbing" title="Permanent link"> ¶</a></h1>
<p>The <code>Phake::when()</code> method is used to stub methods in Phake. As discussed in the introduction,
stubbing allows an object method to be forced to return a particular value given a set of parameters. Similarly to
<code>Phake::verify()</code>, <code>Phake::when()</code> accepts a mock object generated from
<code>Phake::mock()</code> as its first parameter.</p>
<p>Imagine I was in the process of building the next great online shopping cart. The first thing any
good shopping cart allows is to be able to add items. The most important thing I want to know from
the shopping cart is how much money in merchandise is in there. So, I need to make myself a
<code>ShoppingCart</code> class. I also am going to need some class to define my items.
I am more worried about the money right now and because of that I am keenly aware that any item
in a shopping cart is going to have a price. So I will just create an interface to represent those
items called Item. Now take a minute to marvel at the creativity of those
names. Great, now check out the initial definitions for my objects.</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd"> * An item that is going to make me rich.</span>
<span class="sd"> */</span>
<span class="k">interface</span> <span class="nx">Item</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getPrice</span><span class="p">()</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * A customer&#39;s cart that will contain items that are going to make me rich.</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">ShoppingCart</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="sd">/**</span>
<span class="sd">     * Adds an item to the customer&#39;s order</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">addItem</span><span class="p">(</span><span class="nx">Item</span> <span class="nv">$item</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$item</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns the current sub total of the customer&#39;s order</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSubTotal</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>So, I am furiously coding away at this fantastic new <code>ShoppingCart</code> class when I
realize, I am doing it wrong! You see, a few years ago I went to this conference with a bunch of
other geeky people to talk about how to make quality software. I am supposed to be writing unit
tests. Here I am, a solid thirteen lines (not counting comments) of code into my awe inspiring
new software and I haven't written a single test. I tell myself, "There's no better time to change
than right now!" So I decide to start testing. After looking at the options I decide PHPUnit with
this sweet new mock library called Phake is the way to go.</p>
<p>My first test is going to be for the currently unimplemented <code>ShoppingCart::getSubTotal()</code>
method. I already have a pretty good idea of what this function is going to need to do. It will
need to look at all of the items in the cart, retrieve their price, add it all together and return
the result. So, in my test I know I am going to need a fixture that sets up a shopping cart with
a few items added. Then I am going to need a test that calls <code>ShoppingCart::getSubTotal()</code>
and asserts that it returns a value equal to the price of the items I added to the cart. One catch
though, I don't have any concrete instances of an <code>Item</code>. I wasn't even planning on doing any of
that until tomorrow. I really want to just focus on the <code>ShoppingCart</code> class.
Never fear, this is why I decided to use Phake. I remember reading about how it will allow me to
quickly create instance of my classes and interfaces that I can set up stubs for so that method
calls return predictable values. This project is all coming together and I am really excited.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ShoppingCartTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetSub</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$item1</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$item2</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$item3</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$item1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$item2</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$item3</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>

        <span class="nv">$shoppingCart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ShoppingCart</span><span class="p">();</span>
        <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$item1</span><span class="p">);</span>
        <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$item2</span><span class="p">);</span>
        <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$item3</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">getSubTotal</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>My test here shows a very basic use of Phake for creating method stubs. I am creating three different mock
implementations of the <code>Item</code> class. Then for each of those item classes, I am creating
a stub using <code>Phake::when()</code> that will return 100, 200, and 300 respectively. I know my method
that I am getting ready to implement will need to call those methods in order to calculate the total cost of the
order.</p>
<p>My test is written so now it is time to see how it fails. I run it with phpunit and see the output below</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>phpunit<span class="w"> </span>ExampleTests/ShoppingCartTest.php
<span class="go">PHPUnit 9.5.4 by Sebastian Bergmann and contributors.</span>

<span class="go">F                                                                   1 / 1 (100%)</span>

<span class="go">Time: 00:00.012, Memory: 4.00 MB</span>

<span class="go">There was 1 failure:</span>

<span class="go">1) ShoppingCartTest::testGetSub</span>
<span class="go">Failed asserting that null matches expected 600.</span>

<span class="go">/home/mikel/Documents/Projects/Phake/tests/ShoppingCartTest.php:69</span>

<span class="go">FAILURES!</span>
<span class="go">Tests: 1, Assertions: 1, Failures: 1.</span>
</code></pre></div>
<p>Now that I have a working (and I by working I mean breaking!) test it is time to look at the code necessary to make
the test pass.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ShoppingCart</span>
<span class="p">{</span>
    <span class="c1">// I am cutting out the already seen code.</span>
    <span class="c1">// If you want to see it again look at the previous examples!</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns the current sub total of the customer&#39;s order</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSubTotal</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">items</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$total</span> <span class="o">+=</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$total</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The code here is pretty simple. I am just iterating over the <code>ShoppingCart::$item</code> property,
calling the <code>Item::getPrice()</code> method, and adding them all together. Now when I run phpunit, the tests were successful
and I am getting off to a great start with my shopping cart.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>phpunit<span class="w"> </span>ExampleTests/ShoppingCartTest.php
<span class="go">PHPUnit 9.5.4 by Sebastian Bergmann and contributors.</span>

<span class="go">.                                                                   1 / 1 (100%)</span>

<span class="go">Time: 00:00.011, Memory: 4.00 MB</span>

<span class="go">OK (1 test, 1 assertion)</span>
</code></pre></div>
<p>So, what is Phake doing here? Phake is providing us a predictable implementation of the <code>Item::getPrice()</code>
method that we can use in our test. It helps me to ensure the when my test breaks I know exactly where it is breaking.
I will not have to be worried that a bad implementation of <code>Item::getPrice()</code> is breaking my tests.</p>
<h2 id="how-phakewhen-works">How <code>Phake::when()</code> Works<a class="headerlink" href="#how-phakewhen-works" title="Permanent link"> ¶</a></h2>
<p>Internally Phake is doing quite a bit when this test runs. The three calls to <code>Phake::mock()</code> are
creating three new classes that in this case each implement the <code>Item</code> interface. These new classes
each define implementations of any method defined in the <code>Item</code> interface. If <code>Item</code>
extended another interface, implementations of all of that parent's defined methods would be created as well. Each
method being implemented in these new classes does a few different things. The first thing that it does is record
the fact that the method was called and stores the parameters that were used to call it. The next significant thing
it does is looks at the stub map for that mock object. The stub map is a map that associates answers to method matchers.
An answer is what a mocked object will return when it is called. By default, a call to a mock object returns a static
answer of <code>NULL</code>. We will discuss answers more in <a href="../answers/">Answers</a>. A method matcher has two parts. The
first is the method name. The second is an array of arguments. The array of arguments will then contain various constraints
that are applied to each argument to see if a given argument will match. The most common constraint is an equality constraint
that will match loosely along the same lines as the double equals sign in PHP. We will talk about matchers more in
<a href="../method-parameter-matchers/">Method Parameter Matchers</a>.</p>
<p>When each mock object is initially created, its stub map will be empty. This means that any call to a method on a mock object
is going to return a default answer of <code>NULL</code>. If you want your mock object's methods to return something else you must add answers
to the stub map. The <code>Phake::when()</code> method allows you to map an answer to a method matcher for a given mock object.
The mock object you want to add the mapping to is passed as the first parameter to <code>Phake::when()</code>. The
<code>Phake::when()</code> method will then return a proxy that can be used add answers to your mock object's stub
map. The answers are added by making method calls on the proxy just as you would on the mock object you are proxying. In
the first example above you saw a call to <code>Phake::when($this-&gt;item1)-&gt;getPrice()</code>.
The <code>getPrice()</code> call here was telling Phake that I am about to define a new answer that will be returned
any time <code>$this-&gt;item-&gt;getPrice()</code> is called in my code. The call to <code>$this-&gt;item-&gt;getPrice()</code>
returns another object that you can set the answer on using Phake's fluent api. In the example I called
<code>Phake::when($this-&gt;item1)-&gt;getPrice()-&gt;thenReturn(100)</code>. The <code>thenReturn()</code> method will
bind a static answer to a matcher for <code>getPrice()</code> in the stub map for <code>$this-&gt;item1</code>.</p>
<h2 id="overwriting-existing-stubs">Overwriting Existing Stubs<a class="headerlink" href="#overwriting-existing-stubs" title="Permanent link"> ¶</a></h2>
<p>My shopping cart application is coming right along. I can add items and the total price seems to be accurate. However,
while I was playing around with my new cart I noticed a very strange problem. I was playing around with the idea of
allowing discounts to be applied to a cart as just additional items that would have a negative price. So while I am
playing around with this idea I notice that the math isn't always adding up. If I start with an item that is $100 and
then add a discount that is $81.40 I see that the total price isn't adding up to $18.60. This is definitely problematic
After doing some further research, I realize I made a silly mistake. I am just using simple floats to calculate the
costs. Floats are by nature inaccurate. Once you start using them in mathematical operations they start to show their
inadequacy for precision. In keeping with the test driven method of creating code I need to create a unit test this flaw.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ShoppingCartTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
      <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetSub</span><span class="p">()</span>
      <span class="p">{</span>
          <span class="nv">$item1</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
          <span class="nv">$item2</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
          <span class="nv">$item3</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

          <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$item1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
          <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$item2</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
          <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$item3</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>

          <span class="nv">$shoppingCart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ShoppingCart</span><span class="p">();</span>
          <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$item1</span><span class="p">);</span>
          <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$item2</span><span class="p">);</span>
          <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$item3</span><span class="p">);</span>

          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">getSubTotal</span><span class="p">());</span>
      <span class="p">}</span>

      <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetSubTotalWithPrecision</span><span class="p">()</span>
      <span class="p">{</span>
          <span class="nv">$item1</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
          <span class="nv">$item2</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
          <span class="nv">$item3</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

          <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$item1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
          <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$item2</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="o">-</span><span class="mf">81.4</span><span class="p">);</span>
          <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$item3</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

          <span class="nv">$shoppingCart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ShoppingCart</span><span class="p">();</span>
          <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$item1</span><span class="p">);</span>
          <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$item2</span><span class="p">);</span>
          <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$item3</span><span class="p">);</span>

          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mf">38.6</span><span class="p">,</span> <span class="nv">$shoppingCart</span><span class="o">-&gt;</span><span class="na">getSubTotal</span><span class="p">());</span>
      <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>You can see that I added another test method that uses actual floats for some of the prices as opposed to round numbers.
Now when I run my test suite I can see the result.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>phpunit<span class="w"> </span>ExampleTests/ShoppingCartTest.php
<span class="go">PHPUnit 9.5.4 by Sebastian Bergmann and contributors.</span>

<span class="go">..                                                                  2 / 2 (100%)</span>

<span class="go">Time: 00:00.012, Memory: 4.00 MB</span>

<span class="go">OK (2 tests, 2 assertions)</span>
</code></pre></div>
<p>Once you confirmed that your implementation works, I want to discuss streamlining test cases with you. You
will notice that the code in <code>ShoppingCartTest::testGetSubTotalWithPrecision()</code> contains almost
all duplicate code when compared to <code>ShoppingCartTest::testGetSub()</code>. If I were to continue following
this pattern of doing things I would eventually have tests that are difficult to maintain. Phake allows you to very
easily override stubs. This is very important in helping you to reduce duplication in your tests and leads to tests
that will be easier to maintain. To overwrite a previous stub you simply have to redefine it. I am going to change
<code>ShoppingCartTest::testGetSubTotalWithPrecision()</code> to instead just redefine the <code>getPrice()</code>
stubs.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ShoppingCartTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nx">ShoppingCart</span> <span class="nv">$shoppingCart</span><span class="p">;</span>
    <span class="k">private</span> <span class="nx">Item</span> <span class="nv">$item1</span><span class="p">;</span>
    <span class="k">private</span> <span class="nx">Item</span> <span class="nv">$item2</span><span class="p">;</span>
    <span class="k">private</span> <span class="nx">Item</span> <span class="nv">$item3</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item1</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item2</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item3</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item2</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item3</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shoppingCart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ShoppingCart</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item1</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item2</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shoppingCart</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item3</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetSub</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shoppingCart</span><span class="o">-&gt;</span><span class="na">getSubTotal</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetSubTotalWithPrecision</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item2</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="o">-</span><span class="mf">81.4</span><span class="p">);</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item3</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPrice</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mf">38.6</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shoppingCart</span><span class="o">-&gt;</span><span class="na">getSubTotal</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>If you rerun this test you will get the same results shown in before.
The test itself is much simpler though there is much less unnecessary duplication. The reason this works is because
the stub map I was referring to in <a href="#how-phakewhen-works">How <code>Phake::when()</code> works</a> isn't really a map at all. It is more of
a stack in reality. When a new matcher and answer pair is added to a mock object, it is added to the top of the stack.
Then whenever a stub method is called, the stack is checked from the top down to find the first matcher that matches
the method that was called. So, when I created the additional stubs for the various <code>Item::getPrice()</code>
calls, I was just adding additional matchers to the top of the stack that would always get matched first by virtue
of the parameters all being the same.</p>
<h2 id="resetting-a-mocks-stubs">Resetting A Mock's Stubs<a class="headerlink" href="#resetting-a-mocks-stubs" title="Permanent link"> ¶</a></h2>
<p>If overriding a stub does not work for your particular case and you would rather start over with all default stubs then
you can use <code>Phake::reset()</code> and <code>Phake::resetStatic()</code>. These will remove all stubs from a mock and also empty
out all recorded calls against a mock. <code>Phake::reset()</code> will do this for instance methods on the mock and
<code>Phake::resetStatic()</code> will do this for all static methods on the mock.</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span> <span class="k">function</span> <span class="nf">testResettingStubMapper</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$mock</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">PhakeTest_MockedClass</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$mock</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">foo</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="nv">$mock</span><span class="o">-&gt;</span><span class="na">foo</span><span class="p">());</span>

    <span class="nx">Phake</span><span class="o">::</span><span class="na">reset</span><span class="p">(</span><span class="nv">$mock</span><span class="p">);</span>
    <span class="c1">//$mock-&gt;foo() now returns the default stub which in this case is null</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertNull</span><span class="p">(</span><span class="nv">$mock</span><span class="o">-&gt;</span><span class="na">foo</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testResettingCallRecorder</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$mock</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">PhakeTest_MockedClass</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="nv">$mock</span><span class="o">-&gt;</span><span class="na">foo</span><span class="p">();</span>

    <span class="c1">//Will work as normal</span>
    <span class="nx">Phake</span><span class="o">::</span><span class="na">verify</span><span class="p">(</span><span class="nv">$mock</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">foo</span><span class="p">();</span>

    <span class="nx">Phake</span><span class="o">::</span><span class="na">reset</span><span class="p">(</span><span class="nv">$mock</span><span class="p">);</span>

    <span class="c1">//Will now throw an error that foo was not called</span>
    <span class="nx">Phake</span><span class="o">::</span><span class="na">verify</span><span class="p">(</span><span class="nv">$mock</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">foo</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="stubbing-multiple-calls">Stubbing Multiple Calls<a class="headerlink" href="#stubbing-multiple-calls" title="Permanent link"> ¶</a></h2>
<p>Another benefit of the stub mapping in Phake is that it allows you to very easily stub multiple calls to the same
method that use different parameters. In my shopping cart I have decided to add some functionality that will allow
me to easily add multiple products that are a part of a group to the shopping cart. To facilitate this I have decided
to create a new class called <code>ItemGroup</code>. The <code>ItemGroup</code> object will be
constructed with an array of <code>Items</code>. It will have a method on the class that will add all of
the items in the group to the given cart and then the total price of items in the cart will be returned.</p>
<p>It should be noted that earlier I decided to make a small change to the <code>ShoppingCart::addItem()</code>
method to have it return the total price of items in the cart. I figured that this would be nice api level functionality
to make working with the system a little bit easier. I would like to take advantage of that change with this code.
Here's a stub of the functionality I am considering.</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd"> * A group of items that can be added to a cart all at the same time</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">ItemGroup</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @param array $items an array of Item objects</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$items</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @param ShoppingCart $cart</span>
<span class="sd">     * @return money The new total value of the cart</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">addItemsToCart</span><span class="p">(</span><span class="nx">ShoppingCart</span> <span class="nv">$cart</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The next test I am going to write now is going to be focusing on this new <code>ItemGroup::addItemsToCart()</code>
method. In my test's <code>setUp()</code> method I'll create a new instance of <code>ItemGroup</code>
which will require one or more <code>Item</code> implementations. I'll use mocks for those. Then the actual
test case I am going to start with will be a test to assert that <code>ItemGroup::addItemsToCart()</code>
returns the new shopping cart value. I already know that I am going to need to get this value by looking at the
last return value from calls to <code>ShoppingCart::addItem()</code>. To allow for checking this I will mock
<code>ShoppingCart</code> and create three stubs for <code>ShoppingCart::addItem()</code>. Each
stub will be for a call with a different <code>Item</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ItemGroupTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nx">ItemGroup</span> <span class="nv">$itemGroup</span><span class="p">;</span>
    <span class="k">private</span> <span class="nx">Item</span> <span class="nv">$item1</span><span class="p">;</span>
    <span class="k">private</span> <span class="nx">Item</span> <span class="nv">$item2</span><span class="p">;</span>
    <span class="k">private</span> <span class="nx">Item</span> <span class="nv">$item3</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item1</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item2</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item3</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">itemGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ItemGroup</span><span class="p">([</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item1</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item2</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item3</span> <span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testAddItemsToCart</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$cart</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">ShoppingCart</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$cart</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$cart</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item2</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$cart</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item3</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

        <span class="nv">$totalCost</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">itemGroup</span><span class="o">-&gt;</span><span class="na">addItemsToCart</span><span class="p">(</span><span class="nv">$cart</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="nv">$totalCost</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>In this example the <code>ShoppingCart::addItem()</code> method is being stubbed three times. Each time it
is being stubbed with a different parameter being passed to <code>addItem()</code>. This a good example of
how parameters are also checked whenever Phake looks at a mock object's stub map for answers. The default behavior
of argument matching is again a loose equality check. Similar to how you would use the double equals operator in PHP.
The other options for argument matching are discussed further in <a href="../method-parameter-matchers/">Method Parameter Matchers</a>.</p>
<h2 id="stubbing-consecutive-calls">Stubbing Consecutive Calls<a class="headerlink" href="#stubbing-consecutive-calls" title="Permanent link"> ¶</a></h2>
<p>The previous test was a great example for how you can make multiple stubs for a single method however in reality it
is not the best way for that particular test to be written. What if the <code>Item</code> objects in an
<code>ItemGroup</code> aren't stored in the order they were passed in? I am needlessly binding my test
to the order in which objects are stored. Phake provides the ability to map multiple answers to the same stub. This is
done simply by chaining the answers together. I could rewrite the test from the previous chapter to utilize this
feature of Phake.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ItemGroupTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nx">ItemGroup</span> <span class="nv">$itemGroup</span><span class="p">;</span>
    <span class="k">private</span> <span class="nx">Item</span> <span class="nv">$item1</span><span class="p">;</span>
    <span class="k">private</span> <span class="nx">Item</span> <span class="nv">$item2</span><span class="p">;</span>
    <span class="k">private</span> <span class="nx">Item</span> <span class="nv">$item3</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item1</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item2</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item3</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">itemGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ItemGroup</span><span class="p">([</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item1</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item2</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">item3</span> <span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testAddItemsToCart</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$cart</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">ShoppingCart</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$cart</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">addItem</span><span class="p">(</span><span class="nx">Phake</span><span class="o">::</span><span class="na">anyParameters</span><span class="p">())</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

        <span class="nv">$totalCost</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">itemGroup</span><span class="o">-&gt;</span><span class="na">addItemsToCart</span><span class="p">(</span><span class="nv">$cart</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="nv">$totalCost</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>You will notice a few of differences between this example and the example in <a href="#stubbing-multiple-calls">Stubbing Multiple Calls</a>. The first
difference is that there is only one call to <code>Phake::when()</code>. The second difference is that I have chained together three
calls to <code>thenReturn()</code>. The third difference is instead of passing one of my mock Item
objects I have passed the result of the <code>Phake::anyParameters()</code> method. This is a special argument
matcher in Phake that essentially says match any call to the method regardless of the number of parameters or the
value of those parameters. You can learn more about <code>Phake::anyParameters()</code> in <a href="../method-parameter-matchers/#wildcard-parameters">Wildcard Parameters</a>.</p>
<p>So, this single call to <code>Phake::when()</code> is saying: "Whenever a call to <code>$cart-&gt;addItem()</code>
is made, regardless of the parameters, return 10 for the first call, 20 for the second call, and 30 for the third
call." If you are using consecutive call stubbing and you call the method more times than you have answers set, the
last answer will continue to be returned. In this example, if <code>$cart-&gt;addItem()</code> were called a fourth
time, then 30 would be returned again.</p>
<h2 id="stubbing-reference-parameters">Stubbing Reference Parameters<a class="headerlink" href="#stubbing-reference-parameters" title="Permanent link"> ¶</a></h2>
<p>Occasionally you may run into code that utilizes reference parameters to provide additional output
from a method. This is not an uncommon thing to run into with legacy code. Phake provides a custom
parameter matcher (these are discussed further in <a href="../method-parameter-matchers/">Method Parameter Matchers</a>)
that allows you to set reference parameters. It can be accessed using <code>Phake::setReference()</code>.
The only parameter to this matcher is the value you would like to set the reference parameter
to provided all other parameters match.</p>
<div class="highlight"><pre><span></span><code><span class="k">interface</span> <span class="nx">IValidator</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @parm array $data Data to validate</span>
<span class="sd">     * @parm array &amp;$errors contains all validation errors if the data is not valid</span>
<span class="sd">     * @return boolean True when the data is valid</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">validate</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">,</span> <span class="k">array</span> <span class="o">&amp;</span><span class="nv">$errors</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">ValidationLogger</span> <span class="k">implements</span> <span class="nx">IValidator</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$validator</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$log</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">IValidator</span> <span class="nv">$validator</span><span class="p">,</span> <span class="nx">Logger</span> <span class="nv">$log</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validator</span> <span class="o">=</span> <span class="nv">$validator</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span> <span class="o">=</span> <span class="nv">$log</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">validate</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">,</span> <span class="k">array</span> <span class="o">&amp;</span><span class="nv">$errors</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validator</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$errors</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$errors</span> <span class="k">as</span> <span class="nv">$error</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="o">-&gt;</span><span class="na">info</span><span class="p">(</span><span class="s2">&quot;Validation Error: </span><span class="si">{</span><span class="nv">$error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">ValidationLoggerTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testValidate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//Mock the dependencies</span>
        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">IValidator</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$log</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Logger</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;data1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;value&#39;</span> <span class="p">];</span>
        <span class="nv">$expectedErrors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data1 is not valid&#39;</span><span class="p">];</span>

        <span class="c1">//Setup the stubs (Notice the Phake::setReference()</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$validator</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">setReference</span><span class="p">(</span><span class="nv">$expectedErrors</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

        <span class="c1">//Instantiate the SUT</span>
        <span class="nv">$validationLogger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ValidationLogger</span><span class="p">(</span><span class="nv">$validator</span><span class="p">,</span> <span class="nv">$log</span><span class="p">);</span>

        <span class="c1">//verify the validation is false and the message is logged</span>
        <span class="nv">$errors</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertFalse</span><span class="p">(</span><span class="nv">$validationLogger</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$errors</span><span class="p">));</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">verify</span><span class="p">(</span><span class="nv">$log</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">info</span><span class="p">(</span><span class="s1">&#39;Validation Error: data1 is not valid&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>In the example above, I am testing a new class I have created called <code>ValidationLogger</code>.
It is a decorator for other implementations of <code>IValidator</code> that allows adding
logging to any other validator. The <code>IValidator::validate()</code> method will always
return an array of errors into the second parameter (a reference parameter) provided to the method.
These errors are what my logger is responsible for logging. So in order for my test to work properly,
I will need to be able to set that second parameter as a part of my stubbing call.</p>
<p>In the call to <code>Phake::when($validator)-&gt;validate()</code> I have passed a call to
<code>Phake::setReference()</code> as the second parameter. This is causing the mock
implementation of <code>IValidator</code> to set <code>$errors</code> in
<code>ValidationLogger::validate()</code> to the array specified by <code>$expectedErrors</code>.
This allows me to quickly and easily validate that I am actually logging the errors returned back
in the reference parameter.</p>
<p>By default <code>Phake::setReference()</code> will always return true regardless of the
parameter initially passed in. If you would like to only set a reference parameter when that reference
parameter was passed in as a certain value you can use the <code>when()</code> modifier.
This takes a single parameter matcher as an argument. Below,
you will see that the test has been modified to call <code>when()</code> on the result
of <code>Phake::setReference()</code>. This modification will cause the reference parameter
to be set only if the $errors parameter passed to <code>IValidator::validate()</code>
is initially passed as an empty array.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ValidationLoggerTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testValidate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//Mock the dependencies</span>
        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">IValidator</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$log</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">Logger</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;data1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;value&#39;</span> <span class="p">];</span>
        <span class="nv">$expectedErrors</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;data1 is not valid&#39;</span> <span class="p">];</span>

        <span class="c1">//Setup the stubs (Notice the Phake::setReference()</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$validator</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">setReference</span><span class="p">(</span><span class="nv">$expectedErrors</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">when</span><span class="p">([])</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

        <span class="c1">//Instantiate the SUT</span>
        <span class="nv">$validationLogger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ValidationLogger</span><span class="p">(</span><span class="nv">$validator</span><span class="p">,</span> <span class="nv">$log</span><span class="p">);</span>

        <span class="c1">//verify the validation is false and the message is logged</span>
        <span class="nv">$errors</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertFalse</span><span class="p">(</span><span class="nv">$validationLogger</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$errors</span><span class="p">));</span>
        <span class="nx">Phake</span><span class="o">::</span><span class="na">verify</span><span class="p">(</span><span class="nv">$log</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">info</span><span class="p">(</span><span class="s1">&#39;Validation Error: data1 is not valid&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Please note, when you are using <code>Phake::setReference()</code> you still must provide
an answer for the stub. If you use this function and your reference parameter is never changed,
that is generally the most common reason.</p>
<h2 id="partial-mocks">Partial Mocks<a class="headerlink" href="#partial-mocks" title="Permanent link"> ¶</a></h2>
<p>When testing legacy code, if you find that the majority of the methods in the mock are using the <code>thenCallParent()</code>
answer, you may find it easier to just use a partial mock in Phake. Phake partial mocks also allow you to call the
actual constructor of the class being mocked. They are created using <code>Phake::partialMock()</code>. Like <code>Phake::mock()</code>,
the first parameter is the name of the class that you are mocking. However, you can pass additional parameters that
will then be passed as the respective parameters to that class’ constructor. The other notable feature of a partial
mock in Phake is that its default answer is to pass the call through to the parent as if you were using
<code>thenCallParent()</code>.</p>
<p>Consider the following class that has a method that simply returns the value passed into the constructor.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyClass</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$value</span><span class="p">;</span>

    <span class="k">public</span> <span class="nx">__construct</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">value</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">foo</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Using <code>Phake::partialMock()</code> you can instantiate a mock object that will allow this object to function
as designed while still allowing verification as well as selective stubbing of certain calls.
Below is an example that shows the usage of <code>Phake::partialMock()</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyClassTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testCallingParent</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$mock</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">partialMock</span><span class="p">(</span><span class="nx">MyClass</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="mi">42</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="nv">$mock</span><span class="o">-&gt;</span><span class="na">foo</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Again, partial mocks should not be used when you are testing new code. If you find yourself using them be sure to
inspect your design to make sure that the class you are creating a partial mock for is not doing too much.</p>
<h2 id="setting-default-stubs">Setting Default Stubs<a class="headerlink" href="#setting-default-stubs" title="Permanent link"> ¶</a></h2>
<p>You can also change the default stubbing for mocks created with <code>Phake::mock()</code>. This is done by using the second
parameter to <code>Phake::mock()</code> in conjunction with the <code>Phake::ifUnstubbed()</code> method. The second parameter to
<code>Phake::mock()</code> is reserved for configuring the behavior of an individual mock. <code>Phake::ifUnstubbed()</code> allows you
to specify any of the matchers mentioned above as the default answer if any method invocation is not explicitly
stubbed. If this configuration directive is not provided then the method will return <code>NULL</code> by default. An example of
this can be seen below.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyClassTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testDefaultStubs</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$mock</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">MyClass</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">ifUnstubbed</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">42</span><span class="p">));</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="nv">$mock</span><span class="o">-&gt;</span><span class="na">foo</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="stubbing-magic-methods">Stubbing Magic Methods<a class="headerlink" href="#stubbing-magic-methods" title="Permanent link"> ¶</a></h2>
<p>Most magic methods can be stubbed using the method name just like you would any other method. The one exception to this
is the <code>__call()</code> method. This method is overwritten on each mock already to allow for the fluent api that Phake
utilizes. If you want to stub a particular invocation of <code>__call()</code> you can create a stub for the method you are
targetting in the first parameter to <code>__call()</code>.</p>
<p>Consider the following class.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MagicClass</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__call</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;__call&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>You could stub an invocation of the <code>__call()</code> method through a userspace call to <code>magicCall()</code> with the following code.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MagicClassTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testMagicCall</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$mock</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">MagicClass</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

        <span class="nx">Phake</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$mock</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">magicCall</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="nv">$mock</span><span class="o">-&gt;</span><span class="na">magicCall</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>If for any reason you need to explicitly stub calls to <code>__call()</code> then you can use <code>Phake::whenCallMethodWith()</code>.
The matchers passed to <code>Phake::whenCallMethod()</code> will be matched to the method name and array of arguments similar to
what you would expect to be passed to a <code>__call()</code> method. You can also use <code>Phake::anyParameters()</code> instead.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MagicClassTest</span> <span class="k">extends</span> <span class="nx">PHPUnit\Framework\TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testMagicCall</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$mock</span> <span class="o">=</span> <span class="nx">Phake</span><span class="o">::</span><span class="na">mock</span><span class="p">(</span><span class="nx">MagicClass</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

        <span class="nx">Phake</span><span class="o">::</span><span class="na">whenCallMethodWith</span><span class="p">(</span><span class="s1">&#39;magicCall&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">-&gt;</span><span class="na">isCalledOn</span><span class="p">(</span><span class="nv">$mock</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">thenReturn</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="nv">$mock</span><span class="o">-&gt;</span><span class="na">magicCall</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023 Created and maintained by <a href="https://github.com/mlively">Mike Lively</a>, <a href="https://github.com/bfeaver">Brian Feaver</a> and <a href="https://github.com/adoy">Pierrick Charron</a>.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "navigation.tracking", "navigation.tabs", "navigation.sections", "toc.integrate"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
    
  </body>
</html>